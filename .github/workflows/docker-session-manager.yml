name: "üê≥ Build Session Manager"

on:
  push:
    branches: [main]
    paths:
      - 'session-manager/**'
  workflow_dispatch:

env:
  REGISTRY: us-central1-docker.pkg.dev
  PROJECT_ID: hyperbola-476507
  REPOSITORY: docker-repo
  IMAGE_NAME: session-manager

jobs:
  build-push:
    name: "Build & Push Session Manager"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.REGISTRY }}

      - name: Build and Push
        run: |
          cd session-manager
          docker build -t ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:latest .
          docker push ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:latest

      - name: Get GKE credentials
        run: |
          gcloud components install gke-gcloud-auth-plugin
          gcloud container clusters get-credentials primary-cluster-v2 \
            --region us-central1 \
            --project ${{ env.PROJECT_ID }}

      - name: Restart Deployment
        run: |
          kubectl rollout restart deployment/session-manager
          kubectl rollout status deployment/session-manager --timeout=5m

      - name: Verify Deployment
        run: |
          kubectl get pods -l app=session-manager
          kubectl get svc session-manager
