# Minimal, productionâ€‘grade GitHub Actions workflow for Docker build & push
# Focus: minimal set of best practices for regular builds (lint, buildx, auth, push, vuln scan)
name: "ðŸ³ Docker Build & Push (minimal)"

on:
  push:
    branches: [main, dev]
    paths:
      - 'app/**'
  workflow_dispatch:
    inputs:
      push_image:
        description: 'Push image to registry'
        type: boolean
        default: false

concurrency:
  group: docker-${{ github.ref_name }}
  cancel-in-progress: true

env:
  REGISTRY: us-central1-docker.pkg.dev
  PROJECT_ID: hyperbola-476507
  REPOSITORY: docker-repo
  IMAGE_NAME: ai-environment

permissions:
  contents: read
  id-token: write    # enable OIDC if you use it
  packages: write

jobs:
  lint:
    name: "ðŸ” Dockerfile Lint"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Hadolint
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: app/Dockerfile
          failure-threshold: error

  build-push:
    name: "ðŸ—ï¸ Build & Push"
    runs-on: ubuntu-latest
    needs: lint
    environment: ${{ github.ref == 'refs/heads/main' && 'production' || 'development' }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU (multi-arch)
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Configure Docker for GAR
        run: gcloud auth configure-docker ${{ env.REGISTRY }}

      - name: Set metadata
        id: meta
        run: |
          IMAGE_BASE="${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}"
          SHORT_SHA="${GITHUB_SHA::7}"
          TAGS="${IMAGE_BASE}:${SHORT_SHA}"
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            TAGS=","${IMAGE_BASE}:latest","${TAGS}
          elif [[ "${{ github.ref }}" == "refs/heads/dev" ]]; then
            TAGS=","${IMAGE_BASE}:dev","${TAGS}
          fi
          echo "tags=${TAGS}" >> $GITHUB_OUTPUT
          echo "image_base=${IMAGE_BASE}" >> $GITHUB_OUTPUT
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT

      - name: Build and push (buildx)
        id: build
        uses: docker/build-push-action@v5
        with:
          context: ./app
          file: ./app/Dockerfile
          platforms: linux/amd64,linux/arm64
          tags: ${{ steps.meta.outputs.tags }}
          push: ${{ github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev') || (github.event_name == 'workflow_dispatch' && github.event.inputs.push_image == 'true') }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Quick vulnerability scan (Trivy, non-blocking)
        uses: aquasecurity/trivy-action@v0.39.0
        with:
          image-ref: ${{ steps.meta.outputs.image_base }}:${{ steps.meta.outputs.short_sha }}
          format: table
          severity: CRITICAL,HIGH
        continue-on-error: true

      - name: Summary
        if: always()
        run: |
          echo "## Docker build summary" >> $GITHUB_STEP_SUMMARY
          echo "Image: ${{ steps.meta.outputs.image_base }}" >> $GITHUB_STEP_SUMMARY
          echo "Tags: ${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo "SHA: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

# Notes:
# - Keep only the features you actually need: this workflow includes linting, buildx multi-arch,
#   optional OIDC/auth, caching, and a quick non-blocking Trivy scan.
# - Use Workload Identity (OIDC) instead of JSON keys if you can â€” it's more secure.
# - Protect the production environment in repo settings if you want manual gates.
# - If you want image signing, promotion pipelines, SBOMs, or stricter blocking policies,
#   we can add them later as small incremental steps.

