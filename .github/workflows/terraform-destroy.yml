name: Terraform Destroy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to destroy'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
      confirm:
        description: 'Type "DESTROY" to confirm'
        required: true

concurrency:
  group: terraform-state-${{ github.ref }}-${{ github.event_name }}
  cancel-in-progress: false

env:
  TF_VERSION: "1.8.5"
  TF_WORKING_DIR: "environments/${{ github.event.inputs.environment }}"

jobs:
  plan-destroy:
    name: "ðŸ“‹ Plan Destroy - Review Changes"
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm == 'DESTROY'
    outputs:
      run_id: ${{ github.run_id }}
    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Terraform Init
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform init -input=false

      - name: Terraform Plan Destroy
        working-directory: ${{ env.TF_WORKING_DIR }}
        env:
          TF_VAR_project_id: ${{ secrets.GCP_PROJECT_ID }}
          TF_VAR_github_repository: ${{ github.repository }}
        run: |
          terraform plan -destroy -input=false -out=destroy.tfplan
          terraform show -no-color destroy.tfplan > destroy-plan.txt

      - name: Upload Destroy Plan
        uses: actions/upload-artifact@v4
        with:
          name: destroy-plan-${{ github.run_id }}
          path: |
            ${{ env.TF_WORKING_DIR }}/destroy.tfplan
            ${{ env.TF_WORKING_DIR }}/destroy-plan.txt
          retention-days: 5

      - name: Display Destroy Plan
        run: |
          echo "## âš ï¸ Terraform Destroy Plan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Resources to be DESTROYED:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat ${{ env.TF_WORKING_DIR }}/destroy-plan.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **Review the plan above before approving destroy!**" >> $GITHUB_STEP_SUMMARY

  destroy:
    name: "ðŸ”¥ Execute Destroy - REQUIRES APPROVAL"
    runs-on: ubuntu-latest
    needs: plan-destroy
    environment: production
    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Download Destroy Plan
        uses: actions/download-artifact@v4
        with:
          name: destroy-plan-${{ needs.plan-destroy.outputs.run_id }}
          path: ${{ env.TF_WORKING_DIR }}

      - name: Terraform Init
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform init -input=false

      - name: Terraform Destroy
        working-directory: ${{ env.TF_WORKING_DIR }}
        env:
          TF_VAR_project_id: ${{ secrets.GCP_PROJECT_ID }}
          TF_VAR_github_repository: ${{ github.repository }}
        run: |
          if [ -f destroy.tfplan ]; then
            terraform apply -input=false -auto-approve destroy.tfplan
          else
            echo "ERROR: Destroy plan not found"
            exit 1
          fi

      - name: Summary
        run: |
          echo "### âœ… Terraform Destroy Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All infrastructure has been destroyed." >> $GITHUB_STEP_SUMMARY
